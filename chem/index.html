<!DOCTYPE html>

<head>
    <!-- <link async rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
        integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous"> -->
    <script type="text/javascript" src="../js/jquery.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="../css/bootstrap.min.css" crossorigin="anonymous">
    <script type="text/javascript" src="../js/bootstrap.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.loli.net/css2?family=Anonymous+Pro:ital,wght@0,400;0,700;1,400;1,700
&family=Noto+Serif+SC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <title>化学</title>
    <style>
        iframe,
        .well {
            border: 1px solid rgb(173, 173, 173);
            margin-top: 5px;
            border-radius: 5px;
            width: 100%;
        }
    </style>
    <script id="MathJax-script" src="https://cdn.bootcss.com/mathjax/3.0.5/es5/tex-mml-chtml.js"></script>
    <!-- <script src="https://apps.bdimg.com/libs/jquery/1.10.2/jquery.min.js"></script> -->
    <script>
        var list = ['',
            'H', 'He',
            'Li', 'Be', 'B', 'C', 'N', 'O', 'F', 'Ne',
            'Na', 'Mg', 'Al', 'Si', 'P', 'S', 'Cl', 'Ar',
            'K', 'Ca', 'Sc', 'Ti', 'V', 'Cr', 'Mn', 'Fe', 'Co', 'Ni', 'Cu', 'Zn', 'Ga', 'Ge', 'As', 'Se', 'Br', 'Kr',
            'Rb', 'Sr', 'Y', 'Zr', 'Nb', 'Mo', 'Tc', 'Ru', 'Rh', 'Pd', 'Ag', 'Cd', 'In', 'Sn', 'Sb', 'Te', 'I', 'Xe',
            'Cs', 'Ba', 'La', 'Ce', 'Pr', 'Nd', 'Pm', 'Sm', 'Eu', 'Gd', 'Tb', 'Dy', 'Ho', 'Er', 'Tm', 'Yb', 'Lu', 'Hf', 'Ta', 'W', 'Re', 'Os', 'Ir', 'Pt', 'Au', 'Hg', 'Tl', 'Pb', 'Bi', 'Po', 'At', 'Rn',
            'Fr', 'Ra', 'Ac', 'Th', 'Pa', 'U', 'Np', 'Pu', 'Am', 'Cm', 'Bk', 'Cf', 'Es', 'Fm', 'Md', 'No', 'Lr', 'Rf', 'Db', 'Sg', 'Bh', 'Hs', 'Mt', 'Ds', 'Rg', 'Cn', 'Nh', 'Fl', 'Mc', 'Lv', 'Ts', 'Og'
        ]

        var bracket = {}

        function getco(str) {
            var n = str.length, ret = 0
            for (var i = 0; i < n; i++) {
                var ch = str.charAt(i)
                if (isNaN(ch)) break;
                ret *= 10;
                ret += ch - 0;
            }
            str = str.slice(i, n)
            return [ret, str, i]
        }

        function workMolecule(str, st) {
            console.log(str, st)
            var n = str.length, co = 1, ans = {};
            for (let i = 0; i < n; i++) {
                var ch = str.charAt(i)
                var f = {}
                if (ch == '(') {
                    f = workMolecule(str.slice(i + 1, bracket[i + st] - st), st + i + 1)
                    i = bracket[i + st] - st;
                } else if ('A' <= ch && ch <= 'Z') {
                    if (i + 1 < n) {
                        let nch = str.charAt(i + 1)
                        if ('a' <= nch && nch <= 'z') i++, ch += nch
                    }
                    if (f[ch]) f[ch]++;
                    else f[ch] = 1;
                } else return {}
                let g = getco(str.slice(i + 1, n))
                if (g[0]) {
                    for (key in f) {
                        f[key] *= g[0]
                    }
                }
                for (key in f) {

                    if (ans[key]) ans[key] = ans[key] + f[key]
                    else ans[key] = f[key]
                }
                i += g[2]
            }
            console.log('ans', ans)
            return ans;
        }

        function parseMolecule(str) {
            str = str.replace(/[\[{]/g, "(").replace(/[\]}]/g, ")");
            console.log('Parsing molecule', str)
            var n = str.length, co = 1, stack = [], top = 0;
            for (let i = 0; i < n; i++) {
                var ch = str.charAt(i);
                if (ch == '(') stack[top] = i, top++;
                else if (ch == ')') bracket[stack[top - 1]] = i, bracket[i] = stack[top - 1], top--;
                if (top < 0) return {}
            }
            if (top != 0) return {};
            console.log(bracket)
            var g = getco(str)
            if (g[0]) co = g[0]
            var f = workMolecule(g[1], g[2])
            for (key in f) {
                f[key] *= co;
            }
            return f;
        }

        var mode = 'bal', balInput
        $().ready(function () {
            balInput = $("#balInput")[0]
            setBal();
            $("#balInput").keydown(function (e) {
                if (e.keyCode == 13) {
                    $("#balBtn")[0].click();
                }
            });
            $(function () { $("[data-toggle='tooltip']").tooltip(); });
        })
        function setBal() {
            $('#balBtn').text('配平')
            $('#balInput').attr('placeholder', 'CrI3+Cl2+KOH=K2CrO4+KIO4+KCl+H2O')
            $('#balBtn').attr('href', '/chem?CrI3+Cl2+KOH=K2CrO4+KIO4+KCl+H2O')
            $('#balBtn').removeClass('disabled')
            $('#balFrame').show();
            $('#otherFrame').hide();
            mode='bal'
        }
        function setWeigh() {
            $('#balBtn').text('相对质量')
            $('#balInput').attr('placeholder', 'Fe2(SO4)3')
            $('#balBtn').attr('href', '')
            $('#balBtn').addClass('disabled')
            $('#balFrame').hide();
            $('#otherFrame').show();
            mode='weigh'
        }
        function input() {
            if (mode == 'bal') $('#balBtn').attr('href', '/chem?' + ((balInput.value == '') ? 'CrI3+Cl2+KOH=K2CrO4+KIO4+KCl+H2O' : balInput.value))
            else if (mode == 'weigh') {

            }
        }
    </script>

</head>

<body>
    <div>
        <div class="col-lg-6 col-md-6 col-xs-12">
            <div class="input-group">
                <input id="balInput" type="text" class="form-control" oninput="input()">
                <span class="input-group-btn">
                    <a type="button" class="btn btn-default" href="" target="balFrame" id="balBtn">配平</a>
                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                        <span class="caret"></span>
                        <span class="sr-only">切换下拉菜单</span>
                    </button>
                    <ul class="dropdown-menu" role="menu">
                        <li><a href="#" onclick="setBal()">配平</a></li>
                        <li><a href="#" onclick="setWeigh()">相对质量</a></li>
                        <li><a href="#">其他</a></li>
                        <li class="divider"></li>
                        <li><a href="#"  data-toggle="tooltip" data-placement="left"
                            title="将会对所有人可见">发送到数据库</a></li>
                    </ul>
                </span>
            </div>
            <div>
                <iframe name="balFrame" id="balFrame"></iframe>
            </div>
            <div class="well" id="otherFrame">
                \(\text{Fe}_{2}(\text{S}\text{O}_{4})_{3}\)
            </div>
        </div>
    </div>
</body>

</html>